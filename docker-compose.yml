version: '3.8'

services:
  proxy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openai-proxy
    restart: unless-stopped
    ports:
      - "${PROXY_PORT:-3000}:${PROXY_PORT:-3000}"
    environment:
      # Required: OpenAI master API key
      - OPENAI_MASTER_API_KEY=${OPENAI_MASTER_API_KEY}
      # Required: Comma-separated list of client API keys
      - OUR_API_KEYS=${OUR_API_KEYS}
      # Optional: OpenAI base URL (defaults to https://api.openai.com)
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com}
      # Optional: Request timeout
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT:-30s}
      # Optional: Admin API key for admin endpoints
      - ADMIN_API_KEY=${ADMIN_API_KEY:-}
      # Optional: Port for proxy server (defaults to 3000)
      - PORT=${PROXY_PORT:-3000}
      # Use memory store (no database needed)
      - USE_MEMORY_STORE=true
    # Load environment variables from .env file
    env_file:
      - .env
    healthcheck:
      # Healthcheck uses PORT env var from container (defaults to 3000)
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:${PORT:-3000}/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
